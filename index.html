<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Basketball Watch Log</title>
  <style>
    :root{
      --bg:#0b1020; --card:#131a33; --muted:#9aa6c3; --text:#eef2ff;
      --accent:#7c5cff; --danger:#ff4d6d; --ok:#38bdf8; --line:#263055;
      --input:#0f1731;
      --radius:16px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --w: 980px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(124,92,255,.35), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(56,189,248,.25), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:var(--w); margin:0 auto; padding:16px}
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,16,32,.75);
      border-bottom: 1px solid rgba(38,48,85,.55);
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:12px 16px; max-width:var(--w); margin:0 auto;
    }
    .brand{display:flex; flex-direction:column; gap:2px}
    .brand h1{font-size:16px; margin:0; letter-spacing:.4px}
    .brand small{color:var(--muted)}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:1px solid rgba(38,48,85,.8);
      background: rgba(19,26,51,.7);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:600;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{background: rgba(19,26,51,.95); border-color: rgba(124,92,255,.6)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(56,189,248,.75));
      border-color: transparent;
    }
    .btn.danger{border-color: rgba(255,77,109,.6)}
    .btn.ghost{background: transparent; box-shadow:none}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(38,48,85,.8);
      background: rgba(19,26,51,.5);
      color: var(--muted); font-size:12px;
    }
    .grid{display:grid; gap:12px}
    .card{
      background: rgba(19,26,51,.7);
      border:1px solid rgba(38,48,85,.85);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(38,48,85,.7);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .card .hd .title{display:flex; flex-direction:column; gap:4px}
    .card .hd h2{margin:0; font-size:15px}
    .card .hd .meta{color:var(--muted); font-size:12px}
    .card .bd{padding:14px}
    .empty{
      padding:18px; color: var(--muted);
      border: 1px dashed rgba(38,48,85,.9);
      border-radius: var(--radius);
      background: rgba(19,26,51,.35);
    }

    .list{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media(min-width: 780px){
      .list{grid-template-columns: 1fr 1fr;}
    }

    .row{display:grid; gap:10px}
    @media(min-width: 680px){
      .row.cols2{grid-template-columns: 1fr 1fr}
      .row.cols3{grid-template-columns: 1fr 1fr 1fr}
    }
    label{display:flex; flex-direction:column; gap:6px; font-size:12px; color: var(--muted)}
    input, select, textarea{
      width:100%;
      background: rgba(15,23,49,.9);
      color: var(--text);
      border:1px solid rgba(38,48,85,.9);
      border-radius: 12px;
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height: 96px; resize: vertical}
    input:focus, select:focus, textarea:focus{border-color: rgba(124,92,255,.85); box-shadow: 0 0 0 3px rgba(124,92,255,.18)}
    .sectionTitle{
      margin: 18px 0 10px;
      font-size: 13px;
      color: var(--text);
      letter-spacing: .2px;
      display:flex; align-items:center; gap:10px;
    }
    .sectionTitle:before{
      content:"";
      width:10px; height:10px; border-radius: 3px;
      background: rgba(124,92,255,.9);
      box-shadow: 0 0 0 3px rgba(124,92,255,.18);
      flex: 0 0 auto;
    }
    .hr{height:1px; background: rgba(38,48,85,.7); margin:14px 0}
    .kvs{display:grid; gap:10px}
    .kv{
      border:1px solid rgba(38,48,85,.7);
      border-radius: 14px;
      padding:12px;
      background: rgba(15,23,49,.55);
    }
    .kv .k{color:var(--muted); font-size:12px}
    .kv .v{margin-top:6px; font-size:14px; white-space:pre-wrap}
    .table{
      width:100%;
      border-collapse: separate;
      border-spacing:0;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(38,48,85,.8);
      background: rgba(15,23,49,.45);
    }
    .table th, .table td{
      padding:10px;
      border-bottom:1px solid rgba(38,48,85,.6);
      font-size:13px;
      text-align:left;
      vertical-align:top;
    }
    .table th{color:var(--muted); font-weight:700}
    .table tr:last-child td{border-bottom:none}
    .table input{padding:10px; border-radius:12px}
    .small{font-size:12px; color: var(--muted)}
    .right{display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap}
    .hide{display:none !important}
    footer{padding:18px 0 26px; color: var(--muted); font-size:12px}

    .search{
      display:flex; gap:8px; align-items:center;
      margin-top: 10px;
    }
    .search input{flex:1}
    .tag{display:inline-flex; align-items:center; gap:6px; font-size:12px; color:var(--muted)}
    .dot{width:8px; height:8px; border-radius:999px; background: rgba(56,189,248,.9); box-shadow: 0 0 0 3px rgba(56,189,248,.14)}
    .dot.win{background: rgba(56,189,248,.9)}
    .dot.lose{background: rgba(255,77,109,.9); box-shadow: 0 0 0 3px rgba(255,77,109,.14)}
    .dot.draw{background: rgba(250,204,21,.9); box-shadow: 0 0 0 3px rgba(250,204,21,.14)}
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">
      <h1>ğŸ€ Basketball Watch Log</h1>
      <small>è¦³æˆ¦è¨˜éŒ²ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰</small>
    </div>
    <div class="actions">
      <button class="btn primary" id="btnNew">ï¼‹ æ–°è¦è¨˜éŒ²</button>
      <button class="btn" id="btnExport">â¬‡ï¸ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="btn" id="btnImport">â¬†ï¸ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <button class="btn ghost" id="btnReset">åˆæœŸåŒ–</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- LIST -->
  <section id="viewList">
    <div class="card">
      <div class="hd">
        <div class="title">
          <h2>è¨˜éŒ²ä¸€è¦§</h2>
          <div class="meta">ã‚¿ãƒƒãƒ—ã§è©³ç´° / ç·¨é›†</div>
        </div>
        <span class="pill" id="countPill">0ä»¶</span>
      </div>
      <div class="bd">
        <div class="search">
          <input id="q" type="search" placeholder="æ¤œç´¢ï¼šãƒªãƒ¼ã‚° / ãƒãƒ¼ãƒ  / ä¼šå ´ / ãƒ¡ãƒ¢ ãªã©" />
          <button class="btn" id="btnClearQ">ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="hr"></div>
        <div id="list" class="list"></div>
        <div id="empty" class="empty hide">
          ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸Šã®ã€Œï¼‹ æ–°è¦è¨˜éŒ²ã€ã‹ã‚‰è¿½åŠ ã—ã¦ã­ã€‚
        </div>
      </div>
    </div>
  </section>

  <!-- DETAIL -->
  <section id="viewDetail" class="hide">
    <div class="card">
      <div class="hd">
        <div class="title">
          <h2 id="detailTitle">è©³ç´°</h2>
          <div class="meta" id="detailMeta"></div>
        </div>
        <div class="right">
          <button class="btn" id="btnBack">â† æˆ»ã‚‹</button>
          <button class="btn" id="btnEdit">ç·¨é›†</button>
          <button class="btn danger" id="btnDelete">å‰Šé™¤</button>
        </div>
      </div>
      <div class="bd" id="detailBody"></div>
    </div>
  </section>

  <!-- FORM -->
  <section id="viewForm" class="hide">
    <div class="card">
      <div class="hd">
        <div class="title">
          <h2 id="formTitle">æ–°è¦è¨˜éŒ²</h2>
          <div class="meta">1ã€œ2ç”»é¢MVPï¼šè¿½åŠ  / ä¸€è¦§ / è©³ç´°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰</div>
        </div>
        <div class="right">
          <button class="btn" id="btnCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn primary" id="btnSave">ä¿å­˜</button>
        </div>
      </div>
      <div class="bd">
        <div class="sectionTitle">åŸºæœ¬æƒ…å ±</div>
        <div class="row cols2">
          <label>è©¦åˆæ—¥ãƒ»æ™‚é–“
            <input id="f_dateTime" type="datetime-local" />
          </label>
          <label>å¤§ä¼šåãƒ»ãƒªãƒ¼ã‚°
            <input id="f_league" type="text" placeholder="ä¾‹ï¼šB.LEAGUE / NBA / Wãƒªãƒ¼ã‚° ãªã©" />
          </label>
        </div>
        <div class="row cols2">
          <label>ãƒ›ãƒ¼ãƒ ãƒãƒ¼ãƒ 
            <input id="f_homeTeam" type="text" placeholder="ä¾‹ï¼šåƒè‘‰ã‚¸ã‚§ãƒƒãƒ„" />
          </label>
          <label>ã‚¢ã‚¦ã‚§ã‚¤ãƒãƒ¼ãƒ 
            <input id="f_awayTeam" type="text" placeholder="ä¾‹ï¼šç‰çƒã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚­ãƒ³ã‚°ã‚¹" />
          </label>
        </div>
        <div class="row cols2">
          <label>ä¼šå ´å
            <input id="f_venue" type="text" placeholder="ä¾‹ï¼šLaLa arena TOKYO-BAY" />
          </label>
          <label>åº§å¸­
            <input id="f_seat" type="text" placeholder="ä¾‹ï¼š2éš Så¸­ 12åˆ— 8ç•ª" />
          </label>
        </div>

        <div class="hr"></div>
        <div class="sectionTitle">è©¦åˆçµæœ</div>
        <div class="row cols3">
          <label>æœ€çµ‚ã‚¹ã‚³ã‚¢ï¼ˆãƒ›ãƒ¼ãƒ ï¼‰
            <input id="f_finalHome" type="number" inputmode="numeric" min="0" placeholder="ä¾‹ï¼š82" />
          </label>
          <label>æœ€çµ‚ã‚¹ã‚³ã‚¢ï¼ˆã‚¢ã‚¦ã‚§ã‚¤ï¼‰
            <input id="f_finalAway" type="number" inputmode="numeric" min="0" placeholder="ä¾‹ï¼š78" />
          </label>
          <label>å‹æ•—ï¼ˆè‡ªå‹•ï¼‰
            <input id="f_result" type="text" readonly placeholder="ã‚¹ã‚³ã‚¢å…¥åŠ›ã§è‡ªå‹•" />
          </label>
        </div>

        <div class="small">ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼åˆ¥å¾—ç‚¹ï¼ˆç©ºæ¬„OKï¼‰</div>
        <table class="table" id="quartersTable">
          <thead>
            <tr>
              <th style="width:90px">Q</th>
              <th>ãƒ›ãƒ¼ãƒ </th>
              <th>ã‚¢ã‚¦ã‚§ã‚¤</th>
              <th style="width:120px">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="quartersBody"></tbody>
        </table>
        <div style="margin-top:10px" class="right">
          <button class="btn" id="btnAddOT">ï¼‹ å»¶é•·(OT)è¿½åŠ </button>
        </div>

        <div class="hr"></div>
        <div class="sectionTitle">æ³¨ç›®é¸æ‰‹ã®ã‚¹ã‚¿ãƒƒãƒ„</div>
        <div class="small">æœ€ä½é™ã¯ã€Œåå‰ã ã‘ã€ã§ã‚‚OKï¼ˆPTS/REB/ASTã¯ç©ºæ¬„OKï¼‰</div>
        <table class="table" id="playersTable" style="margin-top:10px">
          <thead>
            <tr>
              <th>é¸æ‰‹å</th>
              <th style="width:120px">ãƒãƒ¼ãƒ </th>
              <th style="width:90px">PTS</th>
              <th style="width:90px">REB</th>
              <th style="width:90px">AST</th>
              <th>ãƒ¡ãƒ¢</th>
              <th style="width:120px">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="playersBody"></tbody>
        </table>
        <div style="margin-top:10px" class="right">
          <button class="btn" id="btnAddPlayer">ï¼‹ é¸æ‰‹è¿½åŠ </button>
        </div>

        <div class="hr"></div>
        <div class="sectionTitle">è©¦åˆå†…å®¹ã®ãƒ¡ãƒ¢</div>
        <div class="row">
          <label>è©¦åˆã®å±•é–‹ï¼ˆé€†è»¢ã€æ¥æˆ¦ãªã©ï¼‰
            <textarea id="f_flow" placeholder="ä¾‹ï¼šå‰åŠãƒ“ãƒã‚¤ãƒ³ãƒ‰ã‹ã‚‰3Qã§é€†è»¢ã€çµ‚ç›¤ã¯1ç‚¹å·®ã®æ”»é˜²â€¦"></textarea>
          </label>
          <label>å°è±¡ã«æ®‹ã£ãŸãƒ—ãƒ¬ãƒ¼
            <textarea id="f_play" placeholder="ä¾‹ï¼šæ®‹ã‚Š10ç§’ã®ã‚¯ãƒ©ãƒƒãƒã‚¹ãƒªãƒ¼ã€ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰ã®é€Ÿæ”»â€¦"></textarea>
          </label>
          <label>è‡ªåˆ†ã®é¸ã¶MVP
            <input id="f_mvp" type="text" placeholder="ä¾‹ï¼š#12 ã€‡ã€‡ï¼ˆç†ç”±ã‚‚æ›¸ããªã‚‰ä¸Šã®ãƒ¡ãƒ¢ã¸ï¼‰" />
          </label>
        </div>

        <div class="hr"></div>
        <div class="sectionTitle">ä¼šå ´ã®é›°å›²æ°—ãƒ»ä½“é¨“</div>
        <div class="row">
          <label>ã‚¢ãƒªãƒ¼ãƒŠã‚°ãƒ«ãƒ¡
            <textarea id="f_food" placeholder="ä¾‹ï¼šå”æšã’ä¸¼ã€ã‚¯ãƒ©ãƒ•ãƒˆãƒ“ãƒ¼ãƒ«â€¦"></textarea>
          </label>
          <label>æ¼”å‡ºãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ
            <textarea id="f_event" placeholder="ä¾‹ï¼šå…¥å ´æ¼”å‡ºãŒæ´¾æ‰‹ã€ãƒãƒ¼ãƒ•ã‚¿ã‚¤ãƒ ä¼ç”»â€¦"></textarea>
          </label>
          <label>å¿œæ´ã®æ§˜å­
            <textarea id="f_cheer" placeholder="ä¾‹ï¼šã‚³ãƒ¼ãƒ«ãŒç†±ã„ã€ã‚¢ã‚¦ã‚§ã‚¤ãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼å¤šã‚â€¦"></textarea>
          </label>
          <label>åŒè¡Œè€…ãƒ»å‚™è€ƒ
            <textarea id="f_note" placeholder="ä¾‹ï¼šå®¶æ—ã¨ã€é›¨ã§ç§»å‹•å¤§å¤‰ã€æ¬¡ã¯æ—©ã‚ã«å…¥å ´â€¦"></textarea>
          </label>
        </div>

        <div class="hr"></div>
        <div class="small">â€» ä¿å­˜å…ˆã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆlocalStorageï¼‰ã§ã™ã€‚ç«¯æœ«ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å¤‰ãˆã‚‹ã¨è¦‹ãˆã¾ã›ã‚“ã€‚å¿…è¦ãªã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’ä½¿ã£ã¦ã­ã€‚</div>
      </div>
    </div>
  </section>

  <footer class="wrap">
    <div>Tips: ã¾ãšã¯ã€Œæ—¥ä»˜ãƒ»ãƒªãƒ¼ã‚°ãƒ»ãƒãƒ¼ãƒ ãƒ»ã‚¹ã‚³ã‚¢ãƒ»ä¼šå ´ã€ã ã‘å…¥ã‚Œã¦ä¿å­˜ã§ã‚‚OKã€‚å¾Œã‹ã‚‰ç·¨é›†ã§ãã¾ã™ã€‚</div>
  </footer>
</main>

<script>
  // ===== Storage =====
  const STORAGE_KEY = "bb_watchlog_v1";

  function loadRecords() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      const data = raw ? JSON.parse(raw) : [];
      return Array.isArray(data) ? data : [];
    } catch {
      return [];
    }
  }
  function saveRecords(records) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
  }

  function uid() {
    if (crypto && crypto.randomUUID) return crypto.randomUUID();
    return "id_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function fmtDateTime(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return iso;
    const pad = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function computeResult(finalHome, finalAway, homeTeam, awayTeam) {
    const h = Number(finalHome);
    const a = Number(finalAway);
    if (!Number.isFinite(h) || !Number.isFinite(a)) return "";
    if (h > a) return `ãƒ›ãƒ¼ãƒ å‹ã¡ï¼ˆ${homeTeam || "HOME"}ï¼‰`;
    if (h < a) return `ã‚¢ã‚¦ã‚§ã‚¤å‹ã¡ï¼ˆ${awayTeam || "AWAY"}ï¼‰`;
    return "å¼•ãåˆ†ã‘";
  }

  // ===== UI refs =====
  const viewList = document.getElementById("viewList");
  const viewDetail = document.getElementById("viewDetail");
  const viewForm = document.getElementById("viewForm");

  const listEl = document.getElementById("list");
  const emptyEl = document.getElementById("empty");
  const countPill = document.getElementById("countPill");
  const qEl = document.getElementById("q");

  const detailTitle = document.getElementById("detailTitle");
  const detailMeta = document.getElementById("detailMeta");
  const detailBody = document.getElementById("detailBody");

  const formTitle = document.getElementById("formTitle");

  // form fields
  const f_dateTime = document.getElementById("f_dateTime");
  const f_league = document.getElementById("f_league");
  const f_homeTeam = document.getElementById("f_homeTeam");
  const f_awayTeam = document.getElementById("f_awayTeam");
  const f_venue = document.getElementById("f_venue");
  const f_seat = document.getElementById("f_seat");

  const f_finalHome = document.getElementById("f_finalHome");
  const f_finalAway = document.getElementById("f_finalAway");
  const f_result = document.getElementById("f_result");

  const f_flow = document.getElementById("f_flow");
  const f_play = document.getElementById("f_play");
  const f_mvp = document.getElementById("f_mvp");

  const f_food = document.getElementById("f_food");
  const f_event = document.getElementById("f_event");
  const f_cheer = document.getElementById("f_cheer");
  const f_note = document.getElementById("f_note");

  // dynamic tables
  const quartersBody = document.getElementById("quartersBody");
  const playersBody = document.getElementById("playersBody");

  // buttons
  document.getElementById("btnNew").addEventListener("click", () => openFormForNew());
  document.getElementById("btnBack").addEventListener("click", () => show("list"));
  document.getElementById("btnCancel").addEventListener("click", () => show("list"));
  document.getElementById("btnSave").addEventListener("click", () => onSave());
  document.getElementById("btnEdit").addEventListener("click", () => openFormForEdit(currentId));
  document.getElementById("btnDelete").addEventListener("click", () => onDelete(currentId));
  document.getElementById("btnAddOT").addEventListener("click", () => addQuarterRow(nextOTLabel()));
  document.getElementById("btnAddPlayer").addEventListener("click", () => addPlayerRow());
  document.getElementById("btnExport").addEventListener("click", exportJSON);
  document.getElementById("btnImport").addEventListener("click", importJSON);
  document.getElementById("btnReset").addEventListener("click", resetAll);

  document.getElementById("btnClearQ").addEventListener("click", () => {
    qEl.value = "";
    renderList();
  });
  qEl.addEventListener("input", renderList);

  f_finalHome.addEventListener("input", () => {
    f_result.value = computeResult(f_finalHome.value, f_finalAway.value, f_homeTeam.value, f_awayTeam.value);
  });
  f_finalAway.addEventListener("input", () => {
    f_result.value = computeResult(f_finalHome.value, f_finalAway.value, f_homeTeam.value, f_awayTeam.value);
  });
  f_homeTeam.addEventListener("input", () => {
    f_result.value = computeResult(f_finalHome.value, f_finalAway.value, f_homeTeam.value, f_awayTeam.value);
  });
  f_awayTeam.addEventListener("input", () => {
    f_result.value = computeResult(f_finalHome.value, f_finalAway.value, f_homeTeam.value, f_awayTeam.value);
  });

  // ===== State =====
  let records = loadRecords();
  let currentId = null;

  // ===== Routing-ish =====
  function show(which){
    viewList.classList.toggle("hide", which !== "list");
    viewDetail.classList.toggle("hide", which !== "detail");
    viewForm.classList.toggle("hide", which !== "form");
    if (which === "list") renderList();
  }

  // ===== Quarters =====
  function resetQuarters() {
    quartersBody.innerHTML = "";
    ["Q1","Q2","Q3","Q4"].forEach(q => addQuarterRow(q));
  }
  function nextOTLabel(){
    const labels = [...quartersBody.querySelectorAll("tr")].map(tr => tr.dataset.label);
    const otCount = labels.filter(x => x && x.startsWith("OT")).length;
    return "OT" + (otCount + 1);
  }
  function addQuarterRow(label, homeVal = "", awayVal = "", removable = false){
    const tr = document.createElement("tr");
    tr.dataset.label = label;

    tr.innerHTML = `
      <td><strong>${label}</strong></td>
      <td><input type="number" min="0" inputmode="numeric" placeholder="-" value="${homeVal ?? ""}"></td>
      <td><input type="number" min="0" inputmode="numeric" placeholder="-" value="${awayVal ?? ""}"></td>
      <td></td>
    `;
    const tdOps = tr.querySelector("td:last-child");

    if (label.startsWith("OT")) removable = true;

    if (removable){
      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = "å‰Šé™¤";
      btn.addEventListener("click", () => tr.remove());
      tdOps.appendChild(btn);
    } else {
      tdOps.innerHTML = `<span class="small">å›ºå®š</span>`;
    }
    quartersBody.appendChild(tr);
  }
  function readQuarters(){
    const rows = [...quartersBody.querySelectorAll("tr")];
    return rows.map(tr => {
      const [homeInput, awayInput] = tr.querySelectorAll("input");
      const home = homeInput.value === "" ? null : Number(homeInput.value);
      const away = awayInput.value === "" ? null : Number(awayInput.value);
      return { label: tr.dataset.label, home, away };
    });
  }
  function fillQuarters(qs){
    quartersBody.innerHTML = "";
    // ensure Q1-4 exist first
    const base = ["Q1","Q2","Q3","Q4"];
    const map = new Map((qs||[]).map(x => [x.label, x]));
    base.forEach(label => {
      const x = map.get(label) || {};
      addQuarterRow(label, x.home ?? "", x.away ?? "", false);
    });
    // append OTs if any
    (qs||[]).filter(x => x.label && x.label.startsWith("OT")).forEach(x => {
      addQuarterRow(x.label, x.home ?? "", x.away ?? "", true);
    });
  }

  // ===== Players =====
  function resetPlayers(){
    playersBody.innerHTML = "";
    addPlayerRow();
  }
  function addPlayerRow(p = {}){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="text" placeholder="ä¾‹ï¼š#2 ã€‡ã€‡" value="${esc(p.name)}"></td>
      <td>
        <select>
          <option value="">-</option>
          <option value="home">ãƒ›ãƒ¼ãƒ </option>
          <option value="away">ã‚¢ã‚¦ã‚§ã‚¤</option>
          <option value="other">ãã®ä»–</option>
        </select>
      </td>
      <td><input type="number" min="0" inputmode="numeric" placeholder="-" value="${numOrEmpty(p.pts)}"></td>
      <td><input type="number" min="0" inputmode="numeric" placeholder="-" value="${numOrEmpty(p.reb)}"></td>
      <td><input type="number" min="0" inputmode="numeric" placeholder="-" value="${numOrEmpty(p.ast)}"></td>
      <td><input type="text" placeholder="ä¾‹ï¼šãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ãŒè‰¯ã‹ã£ãŸ" value="${esc(p.note)}"></td>
      <td></td>
    `;
    const sel = tr.querySelector("select");
    sel.value = p.team || "";
    const tdOps = tr.querySelector("td:last-child");
    const btn = document.createElement("button");
    btn.className = "btn";
    btn.textContent = "å‰Šé™¤";
    btn.addEventListener("click", () => tr.remove());
    tdOps.appendChild(btn);
    playersBody.appendChild(tr);
  }
  function readPlayers(){
    const rows = [...playersBody.querySelectorAll("tr")];
    return rows.map(tr => {
      const inputs = tr.querySelectorAll("input");
      const sel = tr.querySelector("select");
      const name = inputs[0].value.trim();
      const team = sel.value;
      const pts = inputs[1].value === "" ? null : Number(inputs[1].value);
      const reb = inputs[2].value === "" ? null : Number(inputs[2].value);
      const ast = inputs[3].value === "" ? null : Number(inputs[3].value);
      const note = inputs[4].value.trim();
      return { name, team, pts, reb, ast, note };
    }).filter(p => p.name !== "" || p.note !== "" || p.pts != null || p.reb != null || p.ast != null);
  }
  function fillPlayers(ps){
    playersBody.innerHTML = "";
    (ps && ps.length ? ps : [{}]).forEach(p => addPlayerRow(p));
  }

  // ===== CRUD =====
  function openFormForNew(){
    currentId = null;
    formTitle.textContent = "æ–°è¦è¨˜éŒ²";
    clearForm();
    show("form");
  }

  function openFormForEdit(id){
    const rec = records.find(r => r.id === id);
    if (!rec) return;
    currentId = id;
    formTitle.textContent = "ç·¨é›†";
    fillForm(rec);
    show("form");
  }

  function clearForm(){
    // defaults
    f_dateTime.value = "";
    f_league.value = "";
    f_homeTeam.value = "";
    f_awayTeam.value = "";
    f_venue.value = "";
    f_seat.value = "";
    f_finalHome.value = "";
    f_finalAway.value = "";
    f_result.value = "";
    f_flow.value = "";
    f_play.value = "";
    f_mvp.value = "";
    f_food.value = "";
    f_event.value = "";
    f_cheer.value = "";
    f_note.value = "";
    resetQuarters();
    resetPlayers();
  }

  function fillForm(rec){
    f_dateTime.value = rec.dateTime || "";
    f_league.value = rec.league || "";
    f_homeTeam.value = rec.homeTeam || "";
    f_awayTeam.value = rec.awayTeam || "";
    f_venue.value = rec.venue || "";
    f_seat.value = rec.seat || "";

    f_finalHome.value = rec.finalHome ?? "";
    f_finalAway.value = rec.finalAway ?? "";
    f_result.value = rec.result || computeResult(rec.finalHome, rec.finalAway, rec.homeTeam, rec.awayTeam);

    fillQuarters(rec.quarters || []);
    fillPlayers(rec.players || []);

    f_flow.value = rec.flow || "";
    f_play.value = rec.play || "";
    f_mvp.value = rec.mvp || "";

    f_food.value = rec.food || "";
    f_event.value = rec.event || "";
    f_cheer.value = rec.cheer || "";
    f_note.value = rec.note || "";
  }

  function onSave(){
    const rec = readForm();
    if (!rec.homeTeam && !rec.awayTeam && !rec.league && !rec.dateTime){
      alert("æœ€ä½ã§ã‚‚ã€Œæ—¥ä»˜ or ãƒªãƒ¼ã‚° or ãƒãƒ¼ãƒ åã€ã‚’å…¥ã‚Œã‚‹ã®ãŒãŠã™ã™ã‚ï¼");
    }

    if (currentId){
      const idx = records.findIndex(r => r.id === currentId);
      if (idx >= 0){
        rec.id = currentId;
        rec.updatedAt = new Date().toISOString();
        records[idx] = rec;
      }
    } else {
      rec.id = uid();
      rec.createdAt = new Date().toISOString();
      rec.updatedAt = rec.createdAt;
      records.unshift(rec);
    }

    // sort: dateTime desc if available, else updatedAt desc
    records.sort((a,b) => (b.dateTime || b.updatedAt || "").localeCompare(a.dateTime || a.updatedAt || ""));

    saveRecords(records);
    currentId = rec.id;
    openDetail(rec.id);
  }

  function readForm(){
    const finalHome = f_finalHome.value === "" ? null : Number(f_finalHome.value);
    const finalAway = f_finalAway.value === "" ? null : Number(f_finalAway.value);
    const homeTeam = f_homeTeam.value.trim();
    const awayTeam = f_awayTeam.value.trim();

    const rec = {
      id: null,
      dateTime: f_dateTime.value,
      league: f_league.value.trim(),
      homeTeam,
      awayTeam,
      venue: f_venue.value.trim(),
      seat: f_seat.value.trim(),

      finalHome,
      finalAway,
      result: computeResult(finalHome, finalAway, homeTeam, awayTeam),
      quarters: readQuarters(),
      players: readPlayers(),

      flow: f_flow.value.trim(),
      play: f_play.value.trim(),
      mvp: f_mvp.value.trim(),

      food: f_food.value.trim(),
      event: f_event.value.trim(),
      cheer: f_cheer.value.trim(),
      note: f_note.value.trim(),

      createdAt: null,
      updatedAt: null
    };
    return rec;
  }

  function onDelete(id){
    const rec = records.find(r => r.id === id);
    if (!rec) return;
    if (!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    records = records.filter(r => r.id !== id);
    saveRecords(records);
    currentId = null;
    show("list");
  }

  // ===== Render list/detail =====
  function renderList(){
    const q = (qEl.value || "").trim().toLowerCase();
    const filtered = records.filter(r => {
      if (!q) return true;
      const blob = [
        r.league, r.homeTeam, r.awayTeam, r.venue, r.seat,
        r.flow, r.play, r.mvp, r.food, r.event, r.cheer, r.note
      ].join(" ").toLowerCase();
      return blob.includes(q);
    });

    countPill.textContent = `${filtered.length}ä»¶`;
    listEl.innerHTML = "";
    emptyEl.classList.toggle("hide", filtered.length !== 0);

    filtered.forEach(r => {
      const matchup = `${r.homeTeam || "HOME"} vs ${r.awayTeam || "AWAY"}`;
      const score = (r.finalHome != null && r.finalAway != null) ? `${r.finalHome} - ${r.finalAway}` : "â€”";
      const dt = fmtDateTime(r.dateTime) || "æ—¥ä»˜æœªè¨­å®š";
      const venue = r.venue || "ä¼šå ´æœªè¨­å®š";
      const league = r.league || "ãƒªãƒ¼ã‚°æœªè¨­å®š";

      const dotClass = (r.finalHome == null || r.finalAway == null) ? "draw"
        : (r.finalHome > r.finalAway ? "win" : (r.finalHome < r.finalAway ? "lose" : "draw"));

      const card = document.createElement("div");
      card.className = "card";
      card.style.cursor = "pointer";
      card.innerHTML = `
        <div class="hd">
          <div class="title">
            <h2>${esc(matchup)}</h2>
            <div class="meta">${esc(dt)} ãƒ» ${esc(league)}</div>
          </div>
          <span class="pill"><span class="dot ${dotClass}"></span>${esc(score)}</span>
        </div>
        <div class="bd">
          <div class="tag"><span class="dot" style="opacity:.35"></span><span>${esc(venue)}</span></div>
          ${r.mvp ? `<div class="small" style="margin-top:8px">MVP: ${esc(r.mvp)}</div>` : `<div class="small" style="margin-top:8px">ãƒ¡ãƒ¢: æœªå…¥åŠ›</div>`}
        </div>
      `;
      card.addEventListener("click", () => openDetail(r.id));
      listEl.appendChild(card);
    });
  }

  function openDetail(id){
    const rec = records.find(r => r.id === id);
    if (!rec) return;
    currentId = id;

    const matchup = `${rec.homeTeam || "HOME"} vs ${rec.awayTeam || "AWAY"}`;
    const score = (rec.finalHome != null && rec.finalAway != null) ? `${rec.finalHome} - ${rec.finalAway}` : "â€”";
    detailTitle.textContent = matchup;
    detailMeta.textContent = `${fmtDateTime(rec.dateTime) || "æ—¥ä»˜æœªè¨­å®š"} ãƒ» ${rec.league || "ãƒªãƒ¼ã‚°æœªè¨­å®š"} ãƒ» ${score}`;

    detailBody.innerHTML = `
      ${kvGrid("åŸºæœ¬æƒ…å ±", [
        ["ä¼šå ´", rec.venue || "â€”"],
        ["åº§å¸­", rec.seat || "â€”"],
      ])}
      ${kvGrid("è©¦åˆçµæœ", [
        ["å‹æ•—", rec.result || "â€”"],
        ["æœ€çµ‚ã‚¹ã‚³ã‚¢", score],
      ])}
      ${quartersView(rec)}
      ${playersView(rec)}
      ${kvGrid("è©¦åˆå†…å®¹ã®ãƒ¡ãƒ¢", [
        ["è©¦åˆã®å±•é–‹", rec.flow || "â€”"],
        ["å°è±¡ã«æ®‹ã£ãŸãƒ—ãƒ¬ãƒ¼", rec.play || "â€”"],
        ["è‡ªåˆ†ã®é¸ã¶MVP", rec.mvp || "â€”"],
      ])}
      ${kvGrid("ä¼šå ´ã®é›°å›²æ°—ãƒ»ä½“é¨“", [
        ["ã‚¢ãƒªãƒ¼ãƒŠã‚°ãƒ«ãƒ¡", rec.food || "â€”"],
        ["æ¼”å‡ºãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ", rec.event || "â€”"],
        ["å¿œæ´ã®æ§˜å­", rec.cheer || "â€”"],
        ["åŒè¡Œè€…ãƒ»å‚™è€ƒ", rec.note || "â€”"],
      ])}
      <div class="hr"></div>
      <div class="small">æ›´æ–°: ${fmtDateTime(rec.updatedAt) || "â€”"}</div>
    `;

    show("detail");
  }

  function kvGrid(title, items){
    const cells = items.map(([k,v]) => `
      <div class="kv">
        <div class="k">${esc(k)}</div>
        <div class="v">${esc(v)}</div>
      </div>
    `).join("");
    return `
      <div class="sectionTitle">${esc(title)}</div>
      <div class="kvs">${cells}</div>
      <div class="hr"></div>
    `;
  }

  function quartersView(rec){
    const qs = (rec.quarters || []).filter(x => x && x.label);
    const any = qs.some(x => x.home != null || x.away != null);
    if (!any) return "";
    const rows = qs.map(x => `
      <tr>
        <td><strong>${esc(x.label)}</strong></td>
        <td>${x.home == null ? "â€”" : esc(String(x.home))}</td>
        <td>${x.away == null ? "â€”" : esc(String(x.away))}</td>
      </tr>
    `).join("");
    return `
      <div class="sectionTitle">ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼åˆ¥å¾—ç‚¹</div>
      <table class="table">
        <thead><tr><th style="width:90px">Q</th><th>ãƒ›ãƒ¼ãƒ </th><th>ã‚¢ã‚¦ã‚§ã‚¤</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="hr"></div>
    `;
  }

  function playersView(rec){
    const ps = (rec.players || []);
    if (!ps.length) return "";
    const rows = ps.map(p => `
      <tr>
        <td>${esc(p.name || "â€”")}</td>
        <td>${esc(teamLabel(p.team))}</td>
        <td>${p.pts == null ? "â€”" : esc(String(p.pts))}</td>
        <td>${p.reb == null ? "â€”" : esc(String(p.reb))}</td>
        <td>${p.ast == null ? "â€”" : esc(String(p.ast))}</td>
        <td>${esc(p.note || "")}</td>
      </tr>
    `).join("");
    return `
      <div class="sectionTitle">æ³¨ç›®é¸æ‰‹ã®ã‚¹ã‚¿ãƒƒãƒ„</div>
      <table class="table">
        <thead><tr>
          <th>é¸æ‰‹å</th><th style="width:120px">ãƒãƒ¼ãƒ </th>
          <th style="width:90px">PTS</th><th style="width:90px">REB</th><th style="width:90px">AST</th>
          <th>ãƒ¡ãƒ¢</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="hr"></div>
    `;
  }

  function teamLabel(v){
    if (v === "home") return "ãƒ›ãƒ¼ãƒ ";
    if (v === "away") return "ã‚¢ã‚¦ã‚§ã‚¤";
    if (v === "other") return "ãã®ä»–";
    return "â€”";
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }
  function numOrEmpty(x){
    return (x == null || Number.isNaN(Number(x))) ? "" : String(x);
  }

  // ===== Export/Import =====
  function exportJSON(){
    const data = JSON.stringify(records, null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `basketball-watchlog-${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function importJSON(){
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = () => {
      const file = input.files && input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const arr = JSON.parse(reader.result);
          if (!Array.isArray(arr)) throw new Error("not array");
          // merge by id
          const map = new Map(records.map(r => [r.id, r]));
          arr.forEach(r => {
            if (!r || typeof r !== "object") return;
            if (!r.id) r.id = uid();
            map.set(r.id, r);
          });
          records = [...map.values()];
          records.sort((a,b) => (b.dateTime || b.updatedAt || "").localeCompare(a.dateTime || a.updatedAt || ""));
          saveRecords(records);
          show("list");
          alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼");
        } catch(e){
          alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆJSONå½¢å¼ã‚’ç¢ºèªã—ã¦ã­ï¼‰");
        }
      };
      reader.readAsText(file, "utf-8");
    };
    input.click();
  }

  function resetAll(){
    if (!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    records = [];
    saveRecords(records);
    show("list");
  }

  // ===== Init =====
  renderList();
  show("list");
</script>
</body>
</html>
